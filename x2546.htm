<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>MariaDB</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="La distribución Aprendiendo de Jesús de OpenBSD como servidor y cortafuegos"
HREF="book1.htm"><LINK
REL="UP"
TITLE="Otros servicios que puede prestar el servidor"
HREF="c2304.htm"><LINK
REL="PREVIOUS"
TITLE="Motor de bases de datos PostgreSQL"
HREF="x2350.htm"><LINK
REL="NEXT"
TITLE="Servidor ldapd"
HREF="x2704.htm"></HEAD
><BODY
CLASS="sect1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>La distribución Aprendiendo de Jesús de OpenBSD como servidor y cortafuegos</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x2350.htm"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Capítulo 6. Otros servicios que puede prestar el servidor</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x2704.htm"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="sect1"
><H1
CLASS="sect1"
><A
NAME="mariadb"
>MariaDB</A
></H1
><P
>A partir de OpenBSD/adJ 5.7 remplaza a MySQL.  Según 
		<A
HREF="https://es.wikipedia.org/wiki/MariaDB"
TARGET="_top"
>https://es.wikipedia.org/wiki/MariaDB</A
> MariaDB fue
		iniciada por el fundador de MySQL después de que Oracle 
		compró Sun y MySQL, pues consideraba que Oracle había
		comprado MySQL para reducir competencia a sus bases 
		de datos.</P
><P
>Debe instalar los paquetes mariadb-client-10.0.16v0 y
	  mariadb-server-10.0.16v0. Aunque el nombre de los paquetes cambia
	  los comandos para operarla siguen siendo los mismos.
	  Tras instalar el servidor debe
      ejecutar <B
CLASS="command"
>mysql_install_db</B
>.  
  </P
><P
>&#13;      Inicialice el directorio donde estarán las bases de datos con
      <PRE
CLASS="screen"
>&#13;sudo /usr/local/bin/mysql_install_db
      </PRE
>
</P
><P
>&#13;    Después agregue a <TT
CLASS="filename"
>/etc/login.conf</TT
>:
    <PRE
CLASS="screen"
>&#13;mysql:\
	:openfiles-cur=2048:\
	:openfiles-max=4096:\
	:tc=daemon:
</PRE
>
que creará una clase de login ---tenga en cuenta no dejar espacios al 
final de cada línea y que desde la segundan comiencen con el caracter
tabulador. A continuación regenere el archivo binario  
<TT
CLASS="filename"
>/etc/login.conf.db</TT
> con
<PRE
CLASS="screen"
>&#13;cd /etc
sudo cap_mkdb /etc/login.conf 
</PRE
>
A continuación agregue <TT
CLASS="literal"
>mysqld</TT
> a 
<TT
CLASS="literal"
>pkg_scripts</TT
> en <TT
CLASS="filename"
>/etc/rc.conf.local</TT
>.
A continuación lance el servidor con:
<PRE
CLASS="screen"
>&#13;	sudo sh /etc/rc.d/mysqld start
</PRE
>
Los errores quedarán en <TT
CLASS="filename"
>/var/mysql/<TT
CLASS="replaceable"
><I
>host</I
></TT
>.err</TT
>.
</P
><P
>&#13;    Después puede establecer una clave para el usuario
    <TT
CLASS="literal"
>root</TT
> de MySQL cuando ingresa desde
    <TT
CLASS="literal"
>localhost</TT
> con:
    <PRE
CLASS="screen"
>&#13;/usr/local/bin/mysqladmin -u root  password 'nueva-clave' 
/usr/local/bin/mysqladmin -u root -pnueva-clave -h Jesus.miescuela.edu.co password 'nueva-clave'
    </PRE
>
    Después puede iniciar una sesión, crear bases de datos, crear usuarios
    y otorgarles privilegios.
    </P
><P
>Para apagar el servidor mysql:
    <PRE
CLASS="screen"
>&#13;mysqladmin -u root -p shutdown
    </PRE
>
  </P
><P
>Si desea usar <SPAN
CLASS="application"
>mysql</SPAN
> con
    <SPAN
CLASS="application"
>php</SPAN
>, instale además de los paquetes
    básicos de php
    (<TT
CLASS="filename"
>php-core-<TT
CLASS="replaceable"
><I
>v</I
></TT
></TT
> y
    <TT
CLASS="filename"
>php-mysql-<TT
CLASS="replaceable"
><I
>v</I
></TT
></TT
>)
  </P
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="uso-mariadb"
>Uso básico</A
></H2
><P
>&#13;    <PRE
CLASS="screen"
>&#13;mysql -u root -p 
    </PRE
>
    puede crear la base de datos <TT
CLASS="literal"
>datos</TT
>, y un
    usuario <TT
CLASS="literal"
>erfurt</TT
> que la pueda administrar (i.e
		    con todos los privilegios excepto GRANT) y con clave
    <TT
CLASS="literal"
>vsewf</TT
> usando:
    <PRE
CLASS="screen"
>&#13;CREATE DATABASE datos;
GRANT ALL PRIVILEGES ON datos.* TO erfurt@localhost IDENTIFIED BY 'vsewf';
    </PRE
>
    </P
><P
>&#13;    Algunas operaciones usuales del administrador son:
    <PRE
CLASS="screen"
>&#13;SHOW DATABASES;
    </PRE
>
    que muestra todas las bases disponibles.
    <PRE
CLASS="screen"
>&#13;USE base1;
    </PRE
>
    que permite usar la base base1.
    <PRE
CLASS="screen"
>&#13;SHOW TABLES;
    </PRE
>
    que muestra todas las tablas de la base activa.
    <PRE
CLASS="screen"
>&#13;DESCRIBE tabla;
SHOW CREATE TABLE tabla;
    </PRE
>
    que presentan estructura de la tabla.

    </P
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="clave-mysql"
>Cambio de la clave de administrador</A
></H2
><P
>Si olvida la clave de root después de haberla establecido 
    puede cambiarla entrando a la cuenta de administrador:
    <P
></P
><UL
><LI
><P
>Detenga el servidor.</P
></LI
><LI
><P
>Inicie el servidor con 
		<B
CLASS="command"
>/usr/local/libexec/mysqld --user=root --skip-grant-tables</B
></P
></LI
><LI
><P
>Ejecute:
	  <PRE
CLASS="screen"
>&#13;# mysql
mysql&#62; use mysql
mysql&#62; update user set password=password('supercosa') where user='root';
mysql&#62; flush privileges;
mysql&#62; exit
	</PRE
></P
></LI
><LI
><P
>Vuelva a apagar el servidor y reinicielo con:
	  <B
CLASS="command"
>/usr/local/bin/mysqld_safe &#38;</B
>
	</P
></LI
></UL
>
  </P
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="recuperacion-backups"
>Recuperación y backups</A
></H2
><P
>&#13;	  MySQL mantiene bases de datos en directorios y las tablas 
	  en archivos.  No es recomendable que modifique tales archivos,
	  al menos no, mientras el servidor esté activo.  
  </P
><P
>&#13;	  Para sacar una copia de respaldo de todas las bases de datos con:
	  <PRE
CLASS="screen"
>&#13;# mysqldump --force -p --all-databases &#62; /respaldomysql/dump-1nov2007.sql
	  </PRE
>
	  y posteriormente restaurarla con:
	  <PRE
CLASS="screen"
>&#13;# mysql &#60; /respaldomysql/dump-1nov2007.sql
	  </PRE
>
  </P
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="chroot-mysql"
>MySQL y Apache con chroot</A
></H2
><P
>Puede emplear aplicaciones para Apache en modo
		  <TT
CLASS="literal"
>chroot</TT
> que usen bases de datos 
		  MySQL de tres formas:
		  (1) Conectándose a un puerto TCP/IP donde responda
		  MySQL, (2) poniendo el socket de MySQL en un directorio
		  dentro de la jaula de Apache o (3) Corriendo MySQL en modo 
		  <TT
CLASS="literal"
>chroot</TT
>.
	  </P
><DIV
CLASS="sect3"
><H3
CLASS="sect3"
><A
NAME="socket-mysql"
>Socket en la jaula de Apache</A
></H3
><P
>&#13;			  Una vez instale <TT
CLASS="literal"
>mysql-server</TT
> 
			  cree el directorio en el cual ubicará
			  el socket, digamos:
			  <PRE
CLASS="screen"
>&#13;mkdir -p /var/www/var/run/mysql/
chown _mysql:_mysql /var/www/var/run/mysql/
chmod a+w /var/www/var/run/mysql/
chmod +t /var/www/var/run/mysql/
			  </PRE
>
			  y después inicie MySQL indicando la ruta del
			  socket con la opción <TT
CLASS="literal"
>--socket</TT
>,
			  por ejemplo para que el cambio se efectúe en
			  cada inicio, edite 
			  <TT
CLASS="filename"
>/etc/rc.conf.local</TT
> para
			  agregar:
<PRE
CLASS="screen"
>&#13;mysqld_flags="--socket=/var/www/var/run/mysql/mysql.sock"
</PRE
>
e inicie desde <TT
CLASS="filename"
>/etc/rc.local</TT
>
con:
<PRE
CLASS="screen"
>&#13;pgrep mysqld &#62; /dev/null
if [ "$?" != 0  -a X"${mysqld_flags}" != X"NO" -a \
	-x /usr/local/bin/mysqld_safe ]; then
	echo -n ' mysqld ' 
	/usr/local/bin/mysqld_safe ${mysqld_flags} &#38;
fi
</PRE
>

Sus aplicaciones PHP pueden entonces conectarse con:
<PRE
CLASS="screen"
>&#13;$dbhost  = "localhost";
$dbuname = "miusuario";
$dbpass  = "miclave";
mysql_connect($dbhost, $dbuname, $dbpass);
</PRE
>
</P
><P
>Tenga en cuenta también que otros binarios de MySQL también requerirán
	la opción <TT
CLASS="literal"
>--socket=/var/www/var/run/mysql/mysql.sock</TT
>
	al ejecutarse por ejemplo:
	<PRE
CLASS="screen"
>&#13;# mysqldump --socket=/var/www/var/run/mysql/mysql.sock  
		\-p --all-databases
	</PRE
>
		  </P
></DIV
><DIV
CLASS="sect3"
><H3
CLASS="sect3"
><A
NAME="mysql-chroot"
>Corriendo MySQL chroot</A
></H3
><P
>Asumimos un servidor apache corriendo chroot en /var/www/
			  Nos proponemos instalar chroot en /var/www/ el servidor mysql.</P
><P
>&#13;	He tomado como base el documento [<SPAN
CLASS="citation"
><A
HREF="b2983.htm#SecMySQL"
>SecMySQL</A
></SPAN
>]
Este fue mi punto de partida, pero sobre la marcha hubo que
añadirle cosas a este procedimiento. A continuación
traduzco la parte pertinente y escribo las modificaciones en naranja. 
</P
><P
>&#13;	<SPAN
CLASS="emphasis"
><I
CLASS="emphasis"
>Nota: Este procedimiento
surgió para Mauricio Rivera a través de un método de ensayo y error
con base en documento que explicaba como instalar el
servidor mysql en un freebsd. Después de varias pruebas
logré correr el servidor mysql y conectarlo a traves de apache,
seguramente la configuración no es la única ni la
óptima pero fue una que me funcionó.
</I
></SPAN
></P
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="volviendo-chroot-el-servidor"
>Volviendo chroot el servidor</A
></H4
><P
>El primer paso para volver seguro a MySQL es preparar el 
		ambiente de cambio de directorio, ambiente en el cual el 
		servidor MySQL irá a correr.
		<SPAN
CLASS="emphasis"
><I
CLASS="emphasis"
>En nuestro caso /var/www/ era el chroot.</I
></SPAN
>
	</P
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="sistema-operativo"
>Sistema operativo</A
></H4
><P
>&#13;			Como en artículos previos, el sistema 
			operativo elegido es
			FreeBSD
			4.7. Sin embargo, los métodos presentados deberán de
			poder aplicarse en la mayoría de sistemas UNIX modernos.
</P
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="Prepara-ambiente-chroot"
>3.2 Preparar el ambiente chroot</A
></H4
><P
>En orden a preparar el ambiente chroot, 
				debemos crear la siguiente estructura de 
				directorios:
<PRE
CLASS="screen"
>&#13;mkdir -p /var/www/dev
mkdir -p /var/www/etc
mkdir -p /var/www/tmp
mkdir -p /var/www/var/tmp
mkdir -p /var/www/usr/local/mysql/libexec
</PRE
>
<PRE
CLASS="screen"
>&#13;mkdir -p /var/www/usr/local/share/mysql/english
mkdir -p /var/www/var/run/mysql
mkdir -p /var/www/var/mysql/
</PRE
>
</P
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="establecer-derechos-de-acceso"
>Establecer derechos de acceso</A
></H4
><P
>&#13;The access rights to the above directories should be set as follows:
<PRE
CLASS="screen"
>&#13;chown -R root.daemon /var/www/
chmod -R 755 /var/www/
chmod 1777 /var/www/tmp
</PRE
>
	</P
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="crear-estructura-de-directorios"
>Crear estructura del directorio</A
></H4
><P
>A continuación, los siguientes archivos han sido copiados 
		en la nueva estructura de directorio: </P
><PRE
CLASS="screen"
>&#13;cp /usr/local/libexec/mysqld 
/var/www/usr/local/mysql/libexec/
cp /usr/local/share/mysql/english/errmsg.sys
/var/www/mysql/usr/local/share/mysql/english/
cp /etc/hosts /var/www/etc/
cp /etc/host* /var/www/etc/
cp /etc/resolv.conf /var/www/etc/
grep mysql /etc/group &#62; /var/www/etc/group
grep mysql /etc/master.passwd &#62; /var/www/etc/master.passwords
grep mysql /etc/passwd &#62; /var/www/etc/passwd
	</PRE
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="filtrar-archivos-de-passwords-y-grupos"
>Filtrar archivos de passwords y grupos</A
></H4
><P
> De los archivos: 
		<TT
CLASS="filename"
>/var/www/etc/passwords</TT
> y 
		<TT
CLASS="filename"
>/var/www/etc/group</TT
>
debemos eliminar todas las líneas excepto las de la cuenta de
mysql (este es _mysql). Esto ya se preparo con el grep anteriro. Luego,
debemos construir la base de datos de contraseñas:
<PRE
CLASS="screen"
>&#13;cd /var/www/etc
pwd_mkdb -d /var/www/mysql/etc passwords
rm -rf /var/www/etc/master.passwd
</PRE
>
</P
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="consideraciones-especiales"
>Consideraciones especiales</A
></H4
><P
>&#13;Igual que en el caso del servidor Apache, debemos crear un archivo de
dispositivo especial <TT
CLASS="filename"
>/dev/null</TT
>:
<PRE
CLASS="screen"
>&#13;ls -al /dev/null
crw-rw-rw-  1 root  sys    2,   2 Jun 21 18:31 /dev/null
mknod /var/www/dev/null c 2 2
chown root.sys /var/www/dev/null
chmod 666 /var/wwww/dev/null
</PRE
>
Debemos de copiar la base de datos <B
CLASS="command"
>mysql</B
>, la cual contiene
tablas creadas durante la instalacion de MySQL:
<PRE
CLASS="screen"
>&#13;cp -R /var/mysql/* /var/www/var/mysql/
chown -R _mysql._mysql /var/www/var/mysql/
</PRE
>
</P
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="corriendo-el-servidor"
>Corriendo el servidor</A
></H4
><P
>&#13;		 Ejecutamos la orden:
		 <PRE
CLASS="screen"
>&#13;mysqld_safe --user=_mysql --chroot=/var/www --datadir=/var/mysql &#38;
		 </PRE
>
		 Comprobamos que el servidor MySQL ese corriendo:
		 <PRE
CLASS="screen"
>&#13;ps -aux|grep -i mysql
		 </PRE
>
		 Corremos el cliente mysql, tenemos decirle que use un 
		 diferente socket:
			 <PRE
CLASS="screen"
>&#13;mysql -S /var/www/var/run/mysql/mysql.sock
			 </PRE
>
aseguramos el acceso al servidor mysql con una clave:
<PRE
CLASS="screen"
>&#13;mysqladmin -S /var/www/var/run/mysql/mysql.sock password 'clave_secreta'
</PRE
>
Hacemos que el servidor mysql arranque cada vez que arranque el
servidor, agregamos la anterior linea al final del archivo
/etc/rc.local:
<PRE
CLASS="screen"
>&#13;mysqladmin -S /var/www/var/run/mysql/mysql.sock password 'clave_secreta'
</PRE
>
</P
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="habilitando-php-en-apache"
>Habilitando php en el servidor apache</A
></H4
><P
>&#13;		 Instalar paquete principal de PHP:
			 <PRE
CLASS="screen"
>&#13;pkg_add php4-core-4.3.5RC3.tgz
			 </PRE
>
			 Crear directorios donde iran las librerias de php para apache:
			 <PRE
CLASS="screen"
>&#13;mkdir -p /chroot/usr/local/lib/php
			 </PRE
>
Copiar la libreria libphp4.so al directorio correspondiente en el
/chroot:
<PRE
CLASS="screen"
>&#13;cp -p /usr/local/lib/php/libphp4.so /chroot/usr/local/lib/php/
</PRE
>
</P
></DIV
><DIV
CLASS="sect4"
><H4
CLASS="sect4"
><A
NAME="habilitando-mysql-con-php-en-apache"
>Habilitando mysql con php en el servidor apache</A
></H4
><P
>&#13;		 Instalar paquete php4-mysql-4.3.5RC3:
		 <PRE
CLASS="screen"
>&#13;pkg_add php4-mysql-4.3.5RC3.tgz
		 </PRE
>
Nota: A modo de prueba copié ciertas librerias mysql a chroot,
que pueden necesitar en el chroot:
<PRE
CLASS="screen"
>&#13;mkdir -p /chroot/usr/local/lib/mysql/
cp -p /usr/local/lib/mysql/* /chroot/usr/local/lib/mysql/
</PRE
>
	  </P
></DIV
></DIV
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="lecutras-mysql"
>Lecturas recomendadas</A
></H2
><P
>&#13;    Referencias:
    <P
></P
><UL
><LI
><P
>Una explicación de algo de la instalación y el uso de 
	  MySQL en OpenBSD: 
	  <A
HREF="http://www.sancho2k.net/filemgmt_data/files/mysql_notes.html"
TARGET="_top"
>http://www.sancho2k.net/filemgmt_data/files/mysql_notes.html</A
>
	</P
></LI
><LI
><P
>El manual de MySQL: 
	  <A
HREF="http://www.mysql.com/documentation/mysql/bychapter/index.html"
TARGET="_top"
>http://www.mysql.com/documentation/mysql/bychapter/index.html</A
>
	</P
></LI
><LI
><P
>Ayuda para cambiar clave de root en sistemas Linux:
	  <A
HREF="http://www.netadmintools.com/art90.html"
TARGET="_top"
>http://www.netadmintools.com/art90.html</A
>
	</P
></LI
></UL
>

  </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x2350.htm"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="book1.htm"
ACCESSKEY="H"
>Inicio</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x2704.htm"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Motor de bases de datos PostgreSQL</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="c2304.htm"
ACCESSKEY="U"
>Subir</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Servidor ldapd</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>